import pytest

from costometer.utils.posterior_utils import greedy_hdi_quantification

simple_test_cases = [
    [[0.25, 0.2, 0.1, 0.2, 0.25], [1, 2, 3, 4, 5], (1, 5)],
    [[0.25, 0.22, 0.1, 0.19, 0.24], [1, 2, 3, 4, 5], (1, 5)],
    [[0.025, 0.225, 0.5, 0.225, 0.025], [0, 2, 5, 7.5, 10], (2, 7.5)],
    [[0.25, 0.5, 0, 0.2, 0.05], [1, 2, 3, 4, 50], (1, 4)],
]

test_inputs = (
    [
        [
            3.07e-05,
            5.75e-02,
            1.09e-03,
            8.80e-04,
            8.03e-04,
            7.23e-04,
            4.15e-04,
            1.54e-04,
            6.87e-03,
            8.10e-01,
            9.78e-02,
            2.41e-02,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            2.87e-23,
            7.62e-16,
            5.87e-05,
            4.32e-04,
            3.98e-04,
            3.52e-04,
            2.01e-04,
            2.87e-04,
            7.85e-01,
            2.11e-01,
            9.54e-04,
            6.23e-04,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            3.04e-40,
            9.47e-30,
            6.22e-17,
            3.88e-05,
            8.88e-05,
            1.03e-04,
            1.53e-02,
            1.06e-01,
            8.02e-01,
            7.57e-02,
            6.60e-04,
            1.17e-05,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            1.71e-47,
            3.05e-38,
            8.13e-20,
            6.35e-10,
            1.61e-08,
            1.69e-07,
            5.28e-05,
            2.42e-03,
            1.12e-01,
            5.20e-01,
            2.52e-01,
            1.14e-01,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            8.46e-41,
            2.24e-32,
            8.26e-15,
            1.14e-15,
            1.01e-15,
            7.44e-15,
            2.87e-10,
            1.42e-06,
            3.13e-01,
            6.20e-01,
            6.64e-02,
            1.03e-05,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            6.86e-52,
            6.62e-41,
            8.24e-24,
            3.99e-09,
            1.45e-07,
            1.98e-06,
            1.39e-03,
            3.28e-01,
            2.19e-01,
            4.37e-01,
            6.81e-03,
            7.71e-03,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            3.04e-39,
            3.57e-31,
            3.03e-13,
            6.82e-07,
            4.73e-06,
            2.33e-05,
            1.25e-03,
            3.14e-02,
            2.20e-01,
            4.52e-01,
            1.60e-01,
            1.35e-01,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            4.53e-01,
            3.61e-01,
            1.50e-01,
            3.39e-02,
            2.99e-03,
            4.83e-12,
            6.83e-22,
            8.43e-29,
            9.59e-34,
            6.51e-49,
            4.61e-63,
            5.71e-75,
            2.61e-86,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            0.00e00,
            1.31e-138,
            1.57e-60,
            7.54e-36,
            5.48e-24,
            1.09e-04,
            6.10e-01,
            3.57e-01,
            3.29e-02,
            4.70e-10,
            8.01e-22,
            5.07e-33,
            4.72e-44,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            1.31e-02,
            3.29e-01,
            4.19e-01,
            1.72e-01,
            6.59e-02,
            4.94e-04,
            1.53e-06,
            2.98e-08,
            1.22e-09,
            6.63e-17,
            2.86e-28,
            1.22e-39,
            4.72e-51,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            4.07e-125,
            2.77e-24,
            9.35e-04,
            3.62e-01,
            3.35e-01,
            3.02e-01,
            1.56e-05,
            4.46e-08,
            1.59e-10,
            5.72e-20,
            3.29e-32,
            1.12e-43,
            7.27e-55,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            8.76e-113,
            6.92e-27,
            6.36e-05,
            4.13e-01,
            5.86e-01,
            9.20e-04,
            1.44e-07,
            3.48e-11,
            1.82e-14,
            8.40e-27,
            5.42e-40,
            1.29e-51,
            7.62e-63,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            5.05e-01,
            3.50e-01,
            1.25e-01,
            1.89e-02,
            1.09e-03,
            8.05e-13,
            1.57e-22,
            5.77e-29,
            1.60e-33,
            1.07e-47,
            2.08e-61,
            3.69e-73,
            1.99e-84,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            5.71e-10,
            1.06e-02,
            5.14e-01,
            4.01e-01,
            7.40e-02,
            4.33e-08,
            4.99e-18,
            5.16e-25,
            4.98e-30,
            2.19e-45,
            1.27e-59,
            1.44e-71,
            6.28e-83,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            1.04e-32,
            5.95e-08,
            3.57e-02,
            4.16e-01,
            5.49e-01,
            4.69e-05,
            1.03e-12,
            2.44e-18,
            9.48e-23,
            2.51e-37,
            2.24e-51,
            2.83e-63,
            1.30e-74,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            4.51e-01,
            4.34e-01,
            8.57e-02,
            2.65e-02,
            2.45e-03,
            6.00e-14,
            3.06e-25,
            1.93e-32,
            1.52e-37,
            4.99e-53,
            2.77e-67,
            3.07e-79,
            1.33e-90,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            5.92e-03,
            2.30e-01,
            3.77e-01,
            2.93e-01,
            9.41e-02,
            4.69e-09,
            2.69e-18,
            1.46e-25,
            7.58e-31,
            5.65e-47,
            1.44e-61,
            1.25e-73,
            4.79e-85,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            1.04e-09,
            2.01e-02,
            4.07e-01,
            4.84e-01,
            8.82e-02,
            1.09e-06,
            5.88e-14,
            3.16e-20,
            5.33e-25,
            3.72e-40,
            2.11e-54,
            2.37e-66,
            1.03e-77,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            7.72e-13,
            5.74e-04,
            8.82e-01,
            1.05e-01,
            1.23e-02,
            1.47e-08,
            1.61e-17,
            6.19e-24,
            1.01e-28,
            8.02e-44,
            5.29e-58,
            6.14e-70,
            2.72e-81,
            0.00e00,
        ],
        [
            0.1,
            0.25,
            0.5,
            0.75,
            1.0,
            2.5,
            5.0,
            7.5,
            10.0,
            25.0,
            50.0,
            75.0,
            100.0,
            1000.0,
        ],
    ],
    [
        [
            3.75e-44,
            9.70e-36,
            4.33e-19,
            1.03e-19,
            5.84e-20,
            2.00e-19,
            1.90e-13,
            1.87e-08,
            1.78e-01,
            7.42e-01,
            8.03e-02,
            1.80e-06,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            2.50e-52,
            2.17e-42,
            2.10e-23,
            2.92e-19,
            3.44e-17,
            1.50e-15,
            1.47e-10,
            4.96e-06,
            2.41e-01,
            5.89e-01,
            1.67e-01,
            2.86e-03,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            7.39e-46,
            6.20e-38,
            4.95e-18,
            9.98e-18,
            5.27e-16,
            1.75e-14,
            2.14e-09,
            3.21e-05,
            1.76e-01,
            6.81e-01,
            1.43e-01,
            7.88e-04,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            1.04e-42,
            6.84e-32,
            3.04e-15,
            3.82e-04,
            2.22e-03,
            8.64e-03,
            4.11e-02,
            1.51e-01,
            5.62e-01,
            2.18e-01,
            1.64e-02,
            1.70e-04,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            3.04e-40,
            9.47e-30,
            6.22e-17,
            3.88e-05,
            8.88e-05,
            1.03e-04,
            1.53e-02,
            1.06e-01,
            8.02e-01,
            7.57e-02,
            6.60e-04,
            1.17e-05,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            2.87e-23,
            7.62e-16,
            5.87e-05,
            4.32e-04,
            3.98e-04,
            3.52e-04,
            2.01e-04,
            2.87e-04,
            7.85e-01,
            2.11e-01,
            9.54e-04,
            6.23e-04,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            1.24e-44,
            3.03e-33,
            2.16e-19,
            2.22e-04,
            8.54e-04,
            1.50e-03,
            4.59e-03,
            1.54e-01,
            7.23e-01,
            1.14e-01,
            1.89e-03,
            2.49e-05,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            5.58e-47,
            3.69e-38,
            7.83e-21,
            1.91e-09,
            2.15e-08,
            1.07e-07,
            2.07e-06,
            5.42e-05,
            1.04e-02,
            1.12e-01,
            1.19e-01,
            7.59e-01,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            3.07e-05,
            5.75e-02,
            1.09e-03,
            8.80e-04,
            8.03e-04,
            7.23e-04,
            4.15e-04,
            1.54e-04,
            6.87e-03,
            8.10e-01,
            9.78e-02,
            2.41e-02,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            3.88e-35,
            1.66e-26,
            8.93e-09,
            2.70e-08,
            2.41e-08,
            1.90e-08,
            7.23e-09,
            8.33e-10,
            2.72e-04,
            7.89e-01,
            4.88e-02,
            1.62e-01,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            9.98e-47,
            2.45e-38,
            2.79e-22,
            8.13e-12,
            1.35e-10,
            9.42e-10,
            8.97e-08,
            5.66e-06,
            3.28e-03,
            5.46e-02,
            1.13e-01,
            8.29e-01,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
    [
        [
            1.15e-01,
            6.92e-09,
            8.85e-01,
            1.67e-24,
            3.11e-29,
            1.12e-42,
            4.57e-54,
            1.12e-57,
            1.30e-63,
            1.24e-68,
            2.62e-72,
            8.51e-75,
        ],
        [-5.0, -2.5, -1.0, -0.1, 0.0, 0.1, 0.5, 1.0, 2.5, 5.0, 7.5, 10.0],
    ],
)

solutions = [
    [-2.5, 7.5],
    [2.5, 5.0],
    [1.0, 5.0],
    [2.5, 10],
    [2.5, 7.5],
    [1.0, 5.0],
    [2.5, 10.0],
    [0.1, 0.50],
    [5.0, 7.5],
    [0.25, 1.0],
    [0.75, 2.5],
    [0.75, 1.0],
    [0.1, 0.5],
    [0.5, 1.0],
    [0.75, 1.0],
    [0.1, 0.5],
    [0.25, 1.0],
    [0.5, 1.0],
    [0.5, 0.75],
    [2.5, 7.5],
    [2.5, 7.5],
    [2.5, 7.5],
    [0.5, 5.0],
    [1.0, 5.0],
    [2.5, 5.0],
    [1.0, 5.0],
    [5.0, 10.0],
    [-2.5, 7.5],
    [5.0, 10.0],
    [5.0, 10.0],
    [-5, -1],
]

real_test_cases = [
    [*test_input, solution] for test_input, solution in zip(test_inputs, solutions)
]


@pytest.mark.parametrize("probs,vals,soln", simple_test_cases)
def test_greedy_quantification_toy(probs, vals, soln):
    assert greedy_hdi_quantification(probs, vals) == list(soln)


@pytest.mark.parametrize("probs,vals,soln", real_test_cases)
def test_greedy_quantification_real(probs, vals, soln):
    assert greedy_hdi_quantification(probs, vals) == soln
